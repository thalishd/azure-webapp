<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestionnaire de Prompts</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; display:flex; flex-direction:column; height:100vh; }
    header { background:#333; color:#fff; padding:1rem; text-align:center; }
    #prompt-list { flex:1; overflow-y:auto; padding:1rem; border-bottom:1px solid #ccc; }
    .prompt-item { padding:.75rem; margin-bottom:.5rem; border:1px solid #ccc; border-radius:5px; background:#fafafa; cursor:pointer; }
    .prompt-item:hover { background:#f0f0f0; }
    #editor { padding:1rem; display:flex; flex-direction:column; gap:.5rem; }
    #prompt-text { width:100%; height:100px; padding:.5rem; font-size:1rem; border:1px solid #ccc; border-radius:5px; resize:vertical; }
    #save-button { padding:.75rem; font-size:1rem; border:none; border-radius:5px; background-color:#4CAF50; color:#fff; cursor:pointer; }
    #save-button:disabled { background-color:#888; cursor:not-allowed; }
  </style>
</head>
<body>
  <header>Gestionnaire de Prompts</header>

  <div id="prompt-list"></div>

  <div id="editor">
    <textarea id="prompt-text" placeholder="Cliquez sur un prompt ou saisissez un nouveau prompt…"></textarea>
    <button id="save-button" disabled>Enregistrer</button>
  </div>

  <script>
    var base_url = "https://azure-api-h0hca4ckb8dwhrcj.swedencentral-01.azurewebsites.net";

    const promptListEl = document.getElementById('prompt-list');
    const promptTextEl = document.getElementById('prompt-text');
    const saveBtn      = document.getElementById('save-button');

    let prompts = [];
    let offset  = 0;
    let selected = null;

    async function loadPrompts() {
      try {
        const response = await fetch(`${base_url}/chats/${offset}`);
        const data = await response.json();
        if (Array.isArray(data.chats) && data.chats.length) {
          data.chats.forEach(item => {
            const idx = prompts.length;
            prompts.push(item);
            const div = document.createElement('div');
            div.className = 'prompt-item';
            div.textContent = item.prompt.length > 50 ? item.prompt.slice(0,50) + '…' : item.prompt;
            div.dataset.index = idx;
            promptListEl.appendChild(div);
          });
          offset += data.chats.length;
        }
      } catch (error) {
        console.error('Erreur chargement prompts :', error);
      }
    }

    promptListEl.addEventListener('scroll', () => {
      if (promptListEl.scrollTop + promptListEl.clientHeight >= promptListEl.scrollHeight - 10) {
        loadPrompts();
      }
    });

    promptListEl.addEventListener('click', e => {
      if (!e.target.classList.contains('prompt-item')) return;
      const idx = Number(e.target.dataset.index);
      selected = { ...prompts[idx], index: idx };
      promptTextEl.value = selected.prompt;
      saveBtn.disabled = false;
    });

    promptTextEl.addEventListener('input', () => {
      saveBtn.disabled = !promptTextEl.value.trim();
    });

    saveBtn.addEventListener('click', async () => {
      const texte = promptTextEl.value.trim();
      if (!texte) return;

      try {
        if (selected) {
          const response = await fetch(`${base_url}/chats/${selected.id}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ prompt: texte })
          });

          if (response.ok) {
            prompts[selected.index].prompt = texte;
            refreshList();
            alert('Prompt mis à jour !');
          } else {
            alert('Erreur lors de la mise à jour.');
          }
        } else {
          const response = await fetch(`${base_url}/chats`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ prompt: texte })
          });

          if (response.ok) {
            prompts = [];
            offset = 0;
            promptListEl.innerHTML = '';
            loadPrompts();
            alert('Nouveau prompt créé !');
          } else {
            alert('Erreur lors de la création.');
          }
        }
      } catch (err) {
        console.error('Erreur requête :', err);
      }

      selected = null;
      promptTextEl.value = '';
      saveBtn.disabled = true;
    });

    function refreshList() {
      promptListEl.innerHTML = '';
      prompts.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'prompt-item';
        div.textContent = item.prompt.length > 50 ? item.prompt.slice(0,50) + '…' : item.prompt;
        div.dataset.index = idx;
        promptListEl.appendChild(div);
      });
    }

    // Chargement initial
    loadPrompts();
  </script>
</body>
</html>